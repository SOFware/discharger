#!/usr/bin/env ruby

# Path to the application root.
APP_ROOT = File.expand_path("..", __dir__)

Dir.chdir(APP_ROOT) do
  # This script uses Discharger to set up your development environment automatically.
  # All setup steps are configured in config/setup.yml
  # This script is idempotent, so you can run it at any time and get an expectable outcome.

  # Find discharger gem path from Gemfile without loading bundler
  # (loading bundler early can cause gem version conflicts)
  gemfile = File.read("Gemfile")
  if (match = gemfile.match(/gem\s+["']discharger["'].*path:\s*["']([^"']+)["']/))
    discharger_path = File.expand_path(match[1], APP_ROOT)
    $LOAD_PATH.unshift(File.join(discharger_path, "lib"))
  else
    # Fall back to installed gem
    begin
      gem "discharger"
    rescue Gem::MissingSpecError
      puts "Could not find discharger gem."
      puts "If using a custom bundle path, try: bundle exec bin/setup"
      exit 1
    end
  end

  require "discharger/setup"
  Discharger::Setup.run("config/setup.yml")
end
